<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>舒適路徑系統</title>
  <!-- Leaflet local assets (no CDN) -->
  <link rel="stylesheet" href="/static/vendor/leaflet/leaflet.css" />
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <header class="app-header">
    <!-- 第一行：標題 + 右側按鈕 -->
    <div class="header-row-1">
      <div class="header-left">
        <h1 data-i18n="title">舒適路徑系統</h1>
      </div>
            <div class="header-right">
              <button id="about-us-btn" class="help-btn" title="關於我們">
                ℹ️<span class="help-text">關於我們</span>
              </button>
              <button id="help-btn" class="help-btn" data-i18n="helpBtn" title="使用說明">
                ❓<span class="help-text">說明</span>
              </button>
              <div class="language-switcher">
                <button id="btn-lang-en" class="lang-btn" data-i18n="langEN" type="button">EN</button>
                <button id="btn-lang-zh" class="lang-btn" data-i18n="langZH" type="button">中文</button>
              </div>
            </div>
    </div>
    
    <!-- 第二行：模式切換 -->
    <div class="header-row-2">
      <div class="header-center">
        <div class="mode-switch">
          <button id="mode-commute" class="mode-btn active" data-i18n="modeCommute">通勤模式</button>
          <button id="mode-metro" class="mode-btn" data-i18n="modeMetro">捷運模式</button>
          <div class="mode-indicator"></div>
        </div>
      </div>
    </div>
  </header>

  <!-- 應用容器 -->
  <div class="app-container">
    <!-- 全屏地圖 -->
    <div id="map" class="fullscreen-map">
    <!-- 地圖圖例 -->
    <div class="map-legend">
      <div class="legend-item">
        <div class="legend-line shortest"></div>
        <span data-i18n="legendShortest">最短路徑</span>
      </div>
      <div class="legend-item">
        <div class="legend-line lowest"></div>
        <span data-i18n="legendLowest">低暴露路徑</span>
      </div>
    </div>

    <!-- 覆蓋層選擇器 -->
    <div class="map-overlay-selector">
      <h4 data-i18n="overlayTitle">覆蓋層</h4>
      <div class="overlay-options">
        <label class="overlay-option">
          <input type="radio" name="overlay" value="none" checked>
          <span data-i18n="overlayNone">無</span>
        </label>
        <label class="overlay-option">
          <input type="radio" name="overlay" value="pm25">
          <span data-i18n="overlayPM25">PM₂.₅</span>
        </label>
        <label class="overlay-option">
          <input type="radio" name="overlay" value="no2">
          <span data-i18n="overlayNO2">NO₂</span>
        </label>
        <label class="overlay-option">
          <input type="radio" name="overlay" value="wbgt">
          <span data-i18n="overlayWBGT">氣溫</span>
        </label>
      </div>
    </div>

    <!-- 底圖選擇器 -->
    <div class="map-tile-selector">
      <button class="tile-selector-button" id="tileSelectorButton">
        <span class="tile-current-name" id="tileCurrentName">底圖樣式</span>
        <span class="tile-dropdown-arrow">▼</span>
      </button>
      <div class="tile-dropdown" id="tileDropdown">
        <div class="tile-option" data-value="cartodb-voyager">淡雅</div>
        <div class="tile-option" data-value="cartodb-light">簡潔</div>
        <div class="tile-option" data-value="cartodb-dark">深色</div>
        <div class="tile-option" data-value="osm">標準</div>
      </div>
    </div>
  </div>

  <!-- 左側功能卡 -->
  <div class="left-panel expanded" id="leftPanel">
    <div class="panel-handle" id="leftPanelHandle">
      <div class="handle-icon">⚙️</div>
      <div class="handle-text" data-i18n="navigationSettings">導航設定</div>
      <div class="handle-arrow">▼</div>
    </div>
    <div class="panel-content">
      <!-- 手機版四行布局 -->
      <div class="mobile-nav-layout">
        <!-- 第一行：起點輸入框 -->
        <div class="nav-row nav-row-1">
          <input type="text" id="input-start" class="text-input-mobile" data-i18n-placeholder="startPlaceholderWithIcon" placeholder="🟢 請輸入起點地址">
        </div>

        <!-- 第二行：終點輸入框 -->
        <div class="nav-row nav-row-2">
          <input type="text" id="input-end" class="text-input-mobile" data-i18n-placeholder="endPlaceholderWithIcon" placeholder="🔴 請輸入終點地址">
        </div>

        <!-- 第三行：交通方式 -->
        <div class="nav-row nav-row-3">
          <div class="transport-row">
            <label class="transport-label" data-i18n="modeLabel">🚗 交通方式</label>
            <div class="radio-group-mobile">
              <label class="radio-option-mobile">
                <input type="radio" name="transport-mode" value="bicycle" checked>
                <span class="radio-text" data-i18n="modeBicycle">單車</span>
              </label>
              <label class="radio-option-mobile">
                <input type="radio" name="transport-mode" value="walk">
                <span class="radio-text" data-i18n="modeWalk">步行</span>
              </label>
            </div>
          </div>
        </div>

        <!-- 第四行：按鈕 -->
        <div class="nav-row nav-row-4">
          <div class="button-row-mobile">
            <button id="plan-btn" class="btn btn-primary-mobile" data-i18n="planBtn">🔍 規劃路徑</button>
            <button id="reset-btn" class="btn btn-secondary-mobile" data-i18n="resetBtn">🔄 重置</button>
          </div>
        </div>
      </div>

      <!-- 桌面版原版布局 -->
      <div class="main-row">
        <!-- 左側：地址輸入 -->
        <div class="address-section">
          <div class="address-group">
            <div class="input-with-coords">
              <input type="text" id="input-start-desktop" class="text-input-compact" data-i18n-placeholder="startPlaceholderWithIcon" placeholder="🟢 請輸入起點地址">
              <span id="coords-start-desktop" class="coords-text">-</span>
            </div>
          </div>
          <div class="address-group">
            <div class="input-with-coords">
              <input type="text" id="input-end-desktop" class="text-input-compact" data-i18n-placeholder="endPlaceholderWithIcon" placeholder="🔴 請輸入終點地址">
              <span id="coords-end-desktop" class="coords-text">-</span>
            </div>
          </div>
        </div>

        <!-- 中間：交通方式 -->
        <div class="transport-section">
          <div class="transport-row-desktop">
            <label class="transport-label-desktop" data-i18n="modeLabel">🚗 交通方式</label>
            <div class="radio-group-desktop">
              <label class="radio-option-desktop">
                <input type="radio" name="transport-mode-desktop" value="bicycle" checked>
                <span class="radio-text" data-i18n="modeBicycle">單車</span>
              </label>
              <label class="radio-option-desktop">
                <input type="radio" name="transport-mode-desktop" value="walk">
                <span class="radio-text" data-i18n="modeWalk">步行</span>
              </label>
            </div>
          </div>
        </div>

        <!-- 右側：按鈕 -->
        <div class="button-section">
          <button id="plan-btn-desktop" class="btn btn-primary" data-i18n="planBtn">🔍 規劃路徑</button>
          <button id="reset-btn-desktop" class="btn btn-secondary" data-i18n="resetBtn">🔄 重置</button>
        </div>
      </div>

    </div>
  </div>

  <!-- 底部結果卡 -->
  <div class="bottom-panel" id="bottomPanel">
    <div class="panel-handle" id="bottomPanelHandle">
      <div class="handle-icon">📊</div>
      <div class="handle-text" data-i18n="routeComparison">路徑比較</div>
      <div class="handle-arrow">▲</div>
    </div>
    <div class="panel-content">
      <!-- 視覺化儀表板 -->
      <div class="dashboard-container" id="dashboardContainer">
        <div class="dashboard-grid">
          <!-- 改善率卡片 - 第一個，使用大數字動畫設計 -->
          <div class="dashboard-card improvement-card">
            <h4 class="card-title">
              <span data-i18n="improvementRate">📈 改善率</span>
              <button class="help-icon-btn" id="improvementHelpBtn" title="改善率說明">❓</button>
            </h4>
            <div class="improvement-display">
              <div class="improvement-number-container">
              <div class="improvement-number" id="dashImprovementRate">0%</div>
              <div class="improvement-subtitle" data-i18n="exposureImprovement">暴露改善</div>
            </div>
            </div>
          </div>

          <!-- 距離比較卡片 -->
          <div class="dashboard-card">
            <h4 class="card-title" data-i18n="distanceComparison">📏 距離比較</h4>
            <div class="comparison-bars">
              <div class="bar-item">
                <div class="bar-header">
                  <span class="route-type shortest" data-i18n="shortest">最短路徑</span>
                  <span class="route-value" id="dashDistanceShortest">-</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill shortest" id="dashDistanceBarShortest"></div>
                </div>
              </div>
              <div class="bar-item">
                <div class="bar-header">
                  <span class="route-type lowest" data-i18n="lowest">低暴露路徑</span>
                  <span class="route-value" id="dashDistanceLowest">-</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill lowest" id="dashDistanceBarLowest"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- 時間比較卡片 -->
          <div class="dashboard-card">
            <h4 class="card-title" data-i18n="timeComparison">⏱️ 時間比較</h4>
            <div class="comparison-bars">
              <div class="bar-item">
                <div class="bar-header">
                  <span class="route-type shortest" data-i18n="shortest">最短路徑</span>
                  <span class="route-value" id="dashTimeShortest">-</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill shortest" id="dashTimeBarShortest"></div>
                </div>
              </div>
              <div class="bar-item">
                <div class="bar-header">
                  <span class="route-type lowest" data-i18n="lowest">低暴露路徑</span>
                  <span class="route-value" id="dashTimeLowest">-</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill lowest" id="dashTimeBarLowest"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- 額外距離卡片 -->
          <div class="dashboard-card">
            <h4 class="card-title" data-i18n="extraDistance">📐 額外距離</h4>
            <div class="metric-display">
              <div class="metric-value" id="dashExtraDistance">-</div>
              <div class="metric-unit">公尺</div>
              <div class="metric-label" data-i18n="lowExposureRoute">低暴露路徑</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div> <!-- 關閉 app-container -->
  
  <!-- 捷運模式面板 -->
  <div id="metro-panel" class="mode-panel" style="display: none;">
    <div class="metro-list-container" id="metro-list-container">
      <div class="metro-container">
        <h2 class="metro-title" data-i18n="metroTitle">🚇 台北捷運路線</h2>
        
        <!-- 路線卡片網格 -->
        <div class="metro-lines-grid">
          <!-- 路線卡片將由 JavaScript 動態生成 -->
        </div>
        
        <!-- 站點彈出層 -->
        <div id="stations-overlay" class="stations-overlay" style="display: none;">
          <div class="stations-modal">
            <div class="stations-header">
              <h3 id="selected-line-name">選擇站點</h3>
              <button id="close-stations" class="close-stations-btn">✕</button>
            </div>
            <div class="stations-grid" id="stations-grid">
              <!-- 站點卡片將由 JavaScript 動態生成 -->
            </div>
          </div>
        </div>
    </div>
  </div>


  <!-- 出口選擇彈窗 -->
    <div id="exit-modal" class="exit-modal" style="display: none;">
      <div class="exit-modal-content">
        <div class="exit-modal-header">
          <h3 id="selected-station-name">象山站</h3>
          <button class="close-exit-modal" onclick="closeExitModal()">✕</button>
        </div>
        <div class="exit-modal-body">
          <div class="selection-container">
            <!-- 左側：出口選擇 -->
            <div class="exit-section">
              <h5 data-i18n="selectExit">選擇出口</h5>
              <div class="exit-buttons" id="exitButtons">
                <button class="exit-btn" data-exit="1" onclick="selectExit(1)">出口1</button>
                <button class="exit-btn" data-exit="2" onclick="selectExit(2)">出口2</button>
                <button class="exit-btn" data-exit="3" onclick="selectExit(3)">出口3</button>
              </div>
            </div>
            
            <!-- 右側：景點選擇 -->
            <div class="attraction-section">
              <h5 data-i18n="nearbyAttractions">附近景點</h5>
              <div class="attraction-buttons" id="attractionButtons">
                <!-- 景點按鈕會動態生成 -->
              </div>
            </div>
          </div>
          
          <!-- 導航按鈕 -->
          <div class="navigation-section">
            <button id="navigationBtn" class="nav-btn" disabled onclick="startNavigation()" data-i18n="startNavigation">開始導航</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 路徑解算結果彈窗 -->
  <div id="route-result-modal" class="route-result-modal" style="display: none;">
    <div class="route-result-content">
      <div class="route-result-header">
        <h3 id="routeResultTitle">路徑解算結果</h3>
        <button class="close-route-result" onclick="closeRouteResultModal()">✕</button>
      </div>
      <div class="route-result-body">
        <!-- 路線地圖 -->
        <div class="route-map-container">
          <div id="route-result-map" class="route-result-map"></div>
        </div>
        
        <!-- 視覺化儀表板 -->
        <div class="result-dashboard-container" id="resultDashboardContainer">
          <div class="result-dashboard-grid">
            <!-- 改善率卡片 - 第一個，使用大數字動畫設計 -->
            <div class="result-dashboard-card result-improvement-card">
              <h4 class="result-card-title">
                <span data-i18n="improvementRate">📈 改善率</span>
                <button class="help-icon-btn" id="resultImprovementHelpBtn" title="改善率說明">❓</button>
              </h4>
              <div class="improvement-display">
                <div class="improvement-number-container">
                  <div class="improvement-number" id="resultDashImprovementRate">0%</div>
                  <div class="improvement-subtitle" data-i18n="exposureImprovement">暴露改善</div>
                </div>
              </div>
            </div>

            <!-- 距離比較卡片 -->
            <div class="result-dashboard-card">
              <h4 class="result-card-title" data-i18n="distanceComparison">📏 距離比較</h4>
              <div class="result-comparison-bars">
                <div class="result-bar-item">
                  <div class="result-bar-header">
                    <span class="result-route-type shortest" data-i18n="shortest">最短路徑</span>
                    <span class="result-route-value" id="resultDashDistanceShortest">-</span>
                  </div>
                  <div class="result-progress-bar">
                    <div class="result-progress-fill shortest" id="resultDashDistanceBarShortest"></div>
                  </div>
                </div>
                <div class="result-bar-item">
                  <div class="result-bar-header">
                    <span class="result-route-type lowest" data-i18n="lowest">低暴露路徑</span>
                    <span class="result-route-value" id="resultDashDistanceLowest">-</span>
                  </div>
                  <div class="result-progress-bar">
                    <div class="result-progress-fill lowest" id="resultDashDistanceBarLowest"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 時間比較卡片 -->
            <div class="result-dashboard-card">
              <h4 class="result-card-title" data-i18n="timeComparison">⏱️ 時間比較</h4>
              <div class="result-comparison-bars">
                <div class="result-bar-item">
                  <div class="result-bar-header">
                    <span class="result-route-type shortest" data-i18n="shortest">最短路徑</span>
                    <span class="result-route-value" id="resultDashTimeShortest">-</span>
                  </div>
                  <div class="result-progress-bar">
                    <div class="result-progress-fill shortest" id="resultDashTimeBarShortest"></div>
                  </div>
                </div>
                <div class="result-bar-item">
                  <div class="result-bar-header">
                    <span class="result-route-type lowest" data-i18n="lowest">低暴露路徑</span>
                    <span class="result-route-value" id="resultDashTimeLowest">-</span>
                  </div>
                  <div class="result-progress-bar">
                    <div class="result-progress-fill lowest" id="resultDashTimeBarLowest"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 額外距離卡片 -->
            <div class="result-dashboard-card">
              <h4 class="result-card-title" data-i18n="extraDistance">📐 額外距離</h4>
              <div class="result-metric-display">
                <div class="result-metric-value" id="resultDashExtraDistance">-</div>
                <div class="result-metric-unit">公尺</div>
                <div class="result-metric-label" data-i18n="lowExposureRoute">低暴露路徑</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 錯誤提示 -->
  <div id="error-box" class="error-card" hidden style="display: none;">
    <p id="error-msg">錯誤訊息</p>
    <button id="error-close" class="error-close">✕</button>
  </div>

  <!-- 使用說明彈出視窗 -->
  <div id="help-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="help-modal-title">使用說明</h3>
        <button id="close-help" class="close-btn">✕</button>
      </div>
      <div class="modal-body">
        <div id="help-content-commute">
          <div class="help-section">
            <h5 data-i18n="commuteFunctionOverview">🎯 功能概述</h5>
            <p data-i18n="commuteFunctionDesc">通勤模式可以為您規劃兩條路徑：最短路徑和低暴露路徑，幫助您在時間和健康之間做出最佳選擇。</p>
          </div>
          
          <div class="help-section">
            <h5 data-i18n="commuteSetPoints">📍 設定起終點</h5>
            <p><strong data-i18n="commuteMethod1">方法一：</strong><span data-i18n="commuteMethod1Desc">在地圖上點擊設定起點和終點</span></p>
            <p><strong data-i18n="commuteMethod2">方法二：</strong><span data-i18n="commuteMethod2Desc">在輸入框中輸入地址，系統會自動定位</span></p>
          </div>
          
          <div class="help-section">
            <h5 data-i18n="commuteTransportMode">🚗 選擇交通方式</h5>
            <p data-i18n="commuteTransportDesc">支援機車、腳踏車、步行三種交通方式，系統會根據不同方式計算相應的通行時間。</p>
          </div>
          
          <div class="help-section">
            <h5 data-i18n="commuteDistanceLimit">📏 距離限制功能</h5>
            <p data-i18n="commuteDistanceLimitDesc">開啟後可設定低暴露路徑的最大額外距離，避免繞路過遠。</p>
          </div>
          
          <div class="help-section">
            <h5 data-i18n="commuteResultInterpretation">📊 結果解讀</h5>
            <p><strong data-i18n="commuteShortestPath">最短路徑：</strong><span data-i18n="commuteShortestPathDesc">距離最短的路線（藍色實線）</span></p>
            <p><strong data-i18n="commuteLowExposurePath">低暴露路徑：</strong><span data-i18n="commuteLowExposurePathDesc">空氣污染暴露最低的路線（綠色虛線）</span></p>
            <p><strong data-i18n="commuteExposureReduction">暴露減少：</strong><span data-i18n="commuteExposureReductionDesc">相比最短路徑減少的污染暴露量</span></p>
            <p><strong data-i18n="commuteImprovementRate">改善率：</strong><span data-i18n="commuteImprovementRateDesc">空氣品質改善的百分比</span></p>
          </div>
        </div>
        
        <div id="help-content-metro">
          <div class="help-section">
            <h5 data-i18n="metroFunctionOverview">🚇 功能概述</h5>
            <p data-i18n="metroFunctionDesc">捷運模式提供台北捷運路線圖，可查看各站出口資訊並規劃到附近景點的最佳路徑。</p>
          </div>
          
          <div class="help-section">
            <h5 data-i18n="metroUsageSteps">🎯 使用步驟</h5>
            <p><strong data-i18n="metroStep1">步驟一：</strong><span data-i18n="metroStep1Desc">點擊捷運地圖上的任一站點</span></p>
            <p><strong data-i18n="metroStep2">步驟二：</strong><span data-i18n="metroStep2Desc">在彈出視窗中選擇出口</span></p>
            <p><strong data-i18n="metroStep3">步驟三：</strong><span data-i18n="metroStep3Desc">選擇想前往的附近景點</span></p>
            <p><strong data-i18n="metroStep4">步驟四：</strong><span data-i18n="metroStep4Desc">點擊「開始導航」查看路徑規劃</span></p>
          </div>
          
          <div class="help-section">
            <h5 data-i18n="metroSupportedStations">📍 支援站點</h5>
            <p data-i18n="metroSupportedStationsDesc">目前支援象山站，提供3個出口選擇和2個熱門景點（豹山步道登山口、富邦美術館）。</p>
          </div>
          
          <div class="help-section">
            <h5 data-i18n="metroRoutePlanning">🗺️ 路徑規劃</h5>
            <p data-i18n="metroRoutePlanningDesc">系統會計算從選定出口到景點的最短路徑和低暴露路徑，並提供詳細的距離、時間和空氣品質分析。</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 改善率說明彈窗 -->
  <div id="improvement-help-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content improvement-help-content">
      <div class="modal-header">
        <h3 data-i18n="improvementRateHelpTitle">改善率計算說明</h3>
        <button class="close-modal" id="closeImprovementHelp">✕</button>
      </div>
      <div class="modal-body">
        <div class="help-section">
          <h5 data-i18n="improvementRateFormula">📊 計算公式</h5>
          <div class="formula-container">
            <div class="formula-box">
              <div class="formula-text">
                <strong data-i18n="improvementRateFormulaText">改善率 = (最短路徑暴露 - 低暴露路徑暴露) ÷ 最短路徑暴露 × 100%</strong>
              </div>
            </div>
          </div>
        </div>
        
        <div class="help-section">
          <h5 data-i18n="improvementRateExplanation">🔍 說明</h5>
          <ul>
            <li data-i18n="improvementRateDesc1">改善率表示低暴露路徑相比最短路徑在空氣污染暴露方面的改善程度</li>
            <li data-i18n="improvementRateDesc2">數值越高表示空氣品質改善效果越好</li>
            <li data-i18n="improvementRateDesc3">暴露量 = PM₂.₅濃度 × 路徑長度</li>
            <li data-i18n="improvementRateDesc4">單位：μg/m³·min（微克每立方公尺每分鐘）</li>
          </ul>
        </div>
        
        <div class="help-section">
          <h5 data-i18n="improvementRateExample">💡 範例</h5>
          <div class="example-container">
            <p data-i18n="improvementRateExampleText">假設最短路徑暴露為 100 μg/m³·min，低暴露路徑暴露為 80 μg/m³·min</p>
            <p data-i18n="improvementRateExampleCalc">改善率 = (100 - 80) ÷ 100 × 100% = 20%</p>
            <p data-i18n="improvementRateExampleResult">表示低暴露路徑比最短路徑減少了 20% 的空氣污染暴露</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/vendor/leaflet/leaflet.js"></script>
  <script src="/static/app.js"></script>
</body>
</html>
